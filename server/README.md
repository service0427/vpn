# VPN Server Setup

VPN μ„λ²„ μλ™ μ„¤μΉ μ¤ν¬λ¦½νΈμ…λ‹λ‹¤. WireGuard VPNμ„ μλ™μΌλ΅ μ„¤μΉν•κ³  API μ„λ²„μ— λ“±λ΅ν•©λ‹λ‹¤.

## π“‹ μ”κµ¬μ‚¬ν•­

- **OS**: Rocky Linux, CentOS, RHEL, Ubuntu, Debian
- **κ¶ν•**: root
- **λ„¤νΈμ›ν¬**: κ³µμΈ IP ν• λ‹Ή, UDP 51820 ν¬νΈ μ¤ν”
- **μ„¤μΉ λ„κµ¬**: curl, jq (μλ™ μ„¤μΉλ¨)

## π€ μ„¤μΉ λ°©λ²•

### 1. μ¤ν¬λ¦½νΈ λ‹¤μ΄λ΅λ“

```bash
# GitμΌλ΅ λ‹¤μ΄λ΅λ“
cd /home
git clone https://github.com/service0427/vpn.git
cd vpn/server
```

### 2. μ‹¤ν–‰ (μλ™ μ„¤μΉ)

```bash
chmod +x setup.sh
./setup.sh
```

**μ‹¤ν–‰ μ‹ μλ™μΌλ΅ μν–‰λλ” μ‘μ—…:**
1. β… OS κ°μ§€ λ° WireGuard μ„¤μΉ
2. β… μ„λ²„/ν΄λΌμ΄μ–ΈνΈ ν‚¤ μƒμ„±
3. β… WireGuard μ„¤μ • νμΌ μƒμ„± (`/etc/wireguard/wg0.conf`)
4. β… IP ν¬μ›λ”© ν™μ„±ν™”
5. β… λ°©ν™”λ²½ μ„¤μ • (firewalld/UFW)
6. β… WireGuard μ„λΉ„μ¤ μ‹μ‘ λ° ν™μ„±ν™”
7. β… ν΄λΌμ΄μ–ΈνΈ μ„¤μ • νμΌ μƒμ„± (`/etc/wireguard/client.conf`)
8. β… **API μ„λ²„μ— μλ™ λ“±λ΅** (112.161.221.82)

### 3. μ¬μ„¤μΉ

κΈ°μ΅΄ VPN μ„¤μ •μ΄ μμ–΄λ„ **λ¬΄μ΅°κ±΄ μλ™ μ¬μ„¤μΉ**λ©λ‹λ‹¤.

```bash
./setup.sh  # κΈ°μ΅΄ μ„¤μ • μλ™ μ κ±° ν›„ μ¬μ„¤μΉ
```

## π“‚ μƒμ„±λλ” νμΌ

```
/etc/wireguard/
β”β”€β”€ wg0.conf              # μ„λ²„ μ„¤μ • (μλ™ μ‹μ‘)
β”β”€β”€ server-private.key    # μ„λ²„ κ°μΈν‚¤
β”β”€β”€ server-public.key     # μ„λ²„ κ³µκ°ν‚¤
β”β”€β”€ client-private.key    # ν΄λΌμ΄μ–ΈνΈ κ°μΈν‚¤
β”β”€β”€ client-public.key     # ν΄λΌμ΄μ–ΈνΈ κ³µκ°ν‚¤
β””β”€β”€ client.conf           # ν΄λΌμ΄μ–ΈνΈ μ„¤μ • (APIλ΅ μ „μ†΅λ¨)
```

## π”§ VPN μ„λ²„ μ„¤μ •

### λ„¤νΈμ›ν¬ μ •λ³΄

- **VPN μ„λΈλ„·**: `10.8.0.0/24`
- **μ„λ²„ μ£Όμ†**: `10.8.0.1`
- **ν΄λΌμ΄μ–ΈνΈ μ£Όμ†**: `10.8.0.2`
- **ν¬νΈ**: `51820/UDP`

### μ„λ²„ μ„¤μ • μμ‹ (`/etc/wireguard/wg0.conf`)

```ini
[Interface]
Address = 10.8.0.1/24
ListenPort = 51820
PrivateKey = <μ„λ²„ κ°μΈν‚¤>

# IP forwarding and NAT
PostUp = sysctl -w net.ipv4.ip_forward=1
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
PostUp = iptables -t nat -A POSTROUTING -o ens160 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT
PostDown = iptables -t nat -D POSTROUTING -o ens160 -j MASQUERADE

# Client config
[Peer]
PublicKey = <ν΄λΌμ΄μ–ΈνΈ κ³µκ°ν‚¤>
AllowedIPs = 10.8.0.2/32
```

## π API λ“±λ΅

μ¤ν¬λ¦½νΈ μ‹¤ν–‰ μ‹ μλ™μΌλ΅ API μ„λ²„μ— λ“±λ΅λ©λ‹λ‹¤.

### API μ„λ²„ μ •λ³΄

- **API μ„λ²„**: `112.161.221.82`
- **DB μ„λ²„**: `220.121.120.83`
- **λ“±λ΅ μ—”λ“ν¬μΈνΈ**: `POST /api/vpn/register`

### λ“±λ΅λλ” λ°μ΄ν„°

```json
{
  "name": "vpn-119-193-40-11",
  "host": "root@119.193.40.11",
  "public_ip": "119.193.40.11",
  "interface": "wg-vpn-119-193-40-11",
  "region": "KR",
  "port": 51820,
  "description": "Auto-generated by setup.sh",
  "client_config": "<WireGuard ν΄λΌμ΄μ–ΈνΈ μ„¤μ •>"
}
```

## π› οΈ κ΄€λ¦¬ λ…λ Ήμ–΄

### VPN μƒνƒ ν™•μΈ

```bash
# WireGuard μƒνƒ
wg show

# μ„λΉ„μ¤ μƒνƒ
systemctl status wg-quick@wg0

# μ—°κ²°λ ν΄λΌμ΄μ–ΈνΈ ν™•μΈ
wg show wg0 peers
```

### VPN μ¬μ‹μ‘

```bash
systemctl restart wg-quick@wg0
```

### VPN μ¤‘μ§€

```bash
systemctl stop wg-quick@wg0
```

### λ΅κ·Έ ν™•μΈ

```bash
journalctl -u wg-quick@wg0 -f
```

### λ°©ν™”λ²½ ν™•μΈ

```bash
# firewalld
firewall-cmd --list-all

# UFW
ufw status

# iptables
iptables -t nat -L POSTROUTING -v
iptables -L FORWARD -v
```

## π” νΈλ¬λΈ”μν…

### 1. VPN μ„λΉ„μ¤ μ‹μ‘ μ‹¤ν¨

```bash
# λ΅κ·Έ ν™•μΈ
journalctl -u wg-quick@wg0 -n 50 --no-pager

# μ„¤μ • νμΌ κ²€μ¦
wg-quick up wg0
```

### 2. ν΄λΌμ΄μ–ΈνΈ μ—°κ²° μ•λ¨

```bash
# λ°©ν™”λ²½ ν™•μΈ
firewall-cmd --list-ports  # 51820/udp μμ–΄μ•Ό ν•¨

# IP ν¬μ›λ”© ν™•μΈ
sysctl net.ipv4.ip_forward  # 1μ΄μ–΄μ•Ό ν•¨

# NAT κ·μΉ™ ν™•μΈ
iptables -t nat -L POSTROUTING -v
```

### 3. API λ“±λ΅ μ‹¤ν¨

```bash
# API μ„λ²„ μ—°κ²° ν™•μΈ
curl http://112.161.221.82/health

# μλ™ λ“±λ΅
curl -X POST http://112.161.221.82/api/vpn/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "vpn-test",
    "host": "root@1.2.3.4",
    "public_ip": "1.2.3.4",
    "interface": "wg-vpn-test",
    "region": "KR",
    "port": 51820,
    "description": "Manual registration",
    "client_config": "'"$(cat /etc/wireguard/client.conf)"'"
  }'
```

## π“ μ£Όμμ‚¬ν•­

1. **μλ™ μ¬μ„¤μΉ**: κΈ°μ΅΄ VPN μ„¤μ •μ΄ μμΌλ©΄ μλ™μΌλ΅ μ κ±°ν•κ³  μ¬μ„¤μΉν•©λ‹λ‹¤
2. **λ°©ν™”λ²½**: ν΄λΌμ°λ“ λ³΄μ• κ·Έλ£Ή/λ°©ν™”λ²½μ—μ„ UDP 51820 ν¬νΈλ¥Ό μ—΄μ–΄μ•Ό ν•©λ‹λ‹¤
3. **λ„¤νΈμ›ν¬**: λ©”μΈ λ„¤νΈμ›ν¬ μΈν„°νμ΄μ¤λ¥Ό μλ™ κ°μ§€ν•©λ‹λ‹¤ (κΈ°λ³Έ λΌμ°νΈ μ‚¬μ©)
4. **κ¶ν•**: root κ¶ν• ν•„μ

## π”— κ΄€λ ¨ λ§ν¬

- [WireGuard κ³µμ‹ λ¬Έμ„](https://www.wireguard.com/)
- [ν΄λΌμ΄μ–ΈνΈ μ„¤μΉ κ°€μ΄λ“](../client/README.md)
