# VPN Server Setup

VPN 서버 자동 설치 스크립트입니다. WireGuard VPN을 자동으로 설치하고 API 서버에 등록합니다.

## 📋 요구사항

- **OS**: Rocky Linux, CentOS, RHEL, Ubuntu, Debian
- **권한**: root
- **네트워크**: 공인 IP 할당, UDP 51820 포트 오픈
- **설치 도구**: curl, jq (자동 설치됨)

## 🚀 설치 방법

### 1. 스크립트 다운로드

```bash
# Git으로 다운로드
cd /home
git clone https://github.com/service0427/vpn.git
cd vpn/server
```

### 2. 실행 (자동 설치)

```bash
chmod +x setup.sh
./setup.sh
```

**실행 시 자동으로 수행되는 작업:**
1. ✅ OS 감지 및 WireGuard 설치
2. ✅ 서버/클라이언트 키 생성
3. ✅ WireGuard 설정 파일 생성 (`/etc/wireguard/wg0.conf`)
4. ✅ IP 포워딩 활성화
5. ✅ 방화벽 설정 (firewalld/UFW)
6. ✅ WireGuard 서비스 시작 및 활성화
7. ✅ 클라이언트 설정 파일 생성 (`/etc/wireguard/client.conf`)
8. ✅ **API 서버에 자동 등록** (112.161.221.82)

### 3. 재설치

기존 VPN 설정이 있어도 **무조건 자동 재설치**됩니다.

```bash
./setup.sh  # 기존 설정 자동 제거 후 재설치
```

## 📂 생성되는 파일

```
/etc/wireguard/
├── wg0.conf              # 서버 설정 (자동 시작)
├── server-private.key    # 서버 개인키
├── server-public.key     # 서버 공개키
├── client-private.key    # 클라이언트 개인키
├── client-public.key     # 클라이언트 공개키
└── client.conf           # 클라이언트 설정 (API로 전송됨)
```

## 🔧 VPN 서버 설정

### 네트워크 정보

- **VPN 서브넷**: `10.8.0.0/24`
- **서버 주소**: `10.8.0.1`
- **클라이언트 주소**: `10.8.0.2`
- **포트**: `51820/UDP`

### 서버 설정 예시 (`/etc/wireguard/wg0.conf`)

```ini
[Interface]
Address = 10.8.0.1/24
ListenPort = 51820
PrivateKey = <서버 개인키>

# IP forwarding and NAT
PostUp = sysctl -w net.ipv4.ip_forward=1
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
PostUp = iptables -t nat -A POSTROUTING -o ens160 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT
PostDown = iptables -t nat -D POSTROUTING -o ens160 -j MASQUERADE

# Client config
[Peer]
PublicKey = <클라이언트 공개키>
AllowedIPs = 10.8.0.2/32
```

## 🌐 API 등록

스크립트 실행 시 자동으로 API 서버에 등록됩니다.

### API 서버 정보

- **API 서버**: `112.161.221.82`
- **DB 서버**: `220.121.120.83`
- **등록 엔드포인트**: `POST /api/vpn/register`

### 등록되는 데이터

```json
{
  "name": "vpn-119-193-40-11",
  "host": "root@119.193.40.11",
  "public_ip": "119.193.40.11",
  "interface": "wg-vpn-119-193-40-11",
  "region": "KR",
  "port": 51820,
  "description": "Auto-generated by setup.sh",
  "client_config": "<WireGuard 클라이언트 설정>"
}
```

## 🛠️ 관리 명령어

### VPN 상태 확인

```bash
# WireGuard 상태
wg show

# 서비스 상태
systemctl status wg-quick@wg0

# 연결된 클라이언트 확인
wg show wg0 peers
```

### VPN 재시작

```bash
systemctl restart wg-quick@wg0
```

### VPN 중지

```bash
systemctl stop wg-quick@wg0
```

### 로그 확인

```bash
journalctl -u wg-quick@wg0 -f
```

### 방화벽 확인

```bash
# firewalld
firewall-cmd --list-all

# UFW
ufw status

# iptables
iptables -t nat -L POSTROUTING -v
iptables -L FORWARD -v
```

## 🔍 트러블슈팅

### 1. VPN 서비스 시작 실패

```bash
# 로그 확인
journalctl -u wg-quick@wg0 -n 50 --no-pager

# 설정 파일 검증
wg-quick up wg0
```

### 2. 클라이언트 연결 안됨

```bash
# 방화벽 확인
firewall-cmd --list-ports  # 51820/udp 있어야 함

# IP 포워딩 확인
sysctl net.ipv4.ip_forward  # 1이어야 함

# NAT 규칙 확인
iptables -t nat -L POSTROUTING -v
```

### 3. API 등록 실패

```bash
# API 서버 연결 확인
curl http://112.161.221.82/health

# 수동 등록
curl -X POST http://112.161.221.82/api/vpn/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "vpn-test",
    "host": "root@1.2.3.4",
    "public_ip": "1.2.3.4",
    "interface": "wg-vpn-test",
    "region": "KR",
    "port": 51820,
    "description": "Manual registration",
    "client_config": "'"$(cat /etc/wireguard/client.conf)"'"
  }'
```

## 📌 주의사항

1. **자동 재설치**: 기존 VPN 설정이 있으면 자동으로 제거하고 재설치합니다
2. **방화벽**: 클라우드 보안 그룹/방화벽에서 UDP 51820 포트를 열어야 합니다
3. **네트워크**: 메인 네트워크 인터페이스를 자동 감지합니다 (기본 라우트 사용)
4. **권한**: root 권한 필수

## 🔗 관련 링크

- [WireGuard 공식 문서](https://www.wireguard.com/)
- [클라이언트 설치 가이드](../client/README.md)
